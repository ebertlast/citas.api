IF OBJECT_ID('TK_CONTRATO_CIT','TR') IS NOT NULL DROP TRIGGER TK_CONTRATO_CIT
GO
CREATE TRIGGER DBO.TK_CONTRATO_CIT
ON  CIT
WITH ENCRYPTION
FOR INSERT, UPDATE, DELETE
AS 
   DECLARE @CONSECUTIVO  VARCHAR(13)
   DECLARE @NO_ITEM      SMALLINT
   DECLARE @IDTERCERO    VARCHAR(20)
   DECLARE @IDPLAN       VARCHAR(6)
   DECLARE @VALOR        DECIMAL(18,6)
   DECLARE @VALORE       DECIMAL(18,6)
   DECLARE @IDCONTRATO   VARCHAR(20)
   DECLARE @FECHA        DATETIME
   DECLARE @AUX          INT
   DECLARE @TIPORESTA    VARCHAR(1)
   DECLARE @IDSERVICIO   VARCHAR(20) 
   DECLARE @GRUPO        VARCHAR(20) 
   DECLARE @CONTRATOCIT  VARCHAR(20)
   DECLARE @IDSEDE       VARCHAR(6)
   DECLARE @IDAFILIADO   VARCHAR(20)
   DECLARE @DIASRES      SMALLINT
   
   IF UPDATE(VALORTOTAL) OR UPDATE(IDTERCEROCA) OR UPDATE(IDPLAN)
   BEGIN
      DECLARE CIT_CURSOR CURSOR FOR  
      SELECT  CONSECUTIVO FROM INSERTED 
      WHERE   INSERTED.IDAFILIADO IS NOT NULL
      OPEN    CIT_CURSOR  
      FETCH NEXT FROM CIT_CURSOR  
      INTO  @CONSECUTIVO
      WHILE @@FETCH_STATUS = 0    
      BEGIN        
         --PRINT 'CONSECUTIVO = '+@CONSECUTIVO    
         SELECT @VALOR     = INSERTED.VALORTOTAL,
                @VALORE    = INSERTED.VALORTOTAL - INSERTED.VALORCOPAGO,
                @IDTERCERO = INSERTED.IDTERCEROCA, @IDPLAN = INSERTED.IDPLAN,
                @FECHA     = INSERTED.FECHA,
                @IDSERVICIO= INSERTED.IDSERVICIO,
                @CONTRATOCIT=INSERTED.IDCONTRATO,
                @IDAFILIADO=INSERTED.IDAFILIADO,
                @IDSEDE=INSERTED.IDSEDE
         FROM   INSERTED 
         WHERE  CONSECUTIVO = @CONSECUTIVO
         
         SELECT @AUX = COUNT(*) FROM CNT 
         WHERE  IDTERCERO   = @IDTERCERO AND IDPLAN = @IDPLAN
         AND    FECHAFINAL   >= @FECHA
         AND    FECHAINICIAL <= @FECHA 
         --PRINT 'CONTADOR DE CNT = '+ STR(@AUX)
         IF @AUX = 0
         BEGIN
            SELECT @IDCONTRATO = 'SIN_DEFINIR'
         END
         ELSE
         BEGIN   
            SELECT TOP 1 @IDCONTRATO = IDCONTRATO, @TIPORESTA = TIPORESTA FROM CNT
            WHERE  IDTERCERO     = @IDTERCERO 
            AND    IDPLAN        = @IDPLAN
            AND    FECHAFINAL   >= @FECHA
            AND    FECHAINICIAL <= @FECHA 
            AND    ESTADO='Activo'
            AND    IDCONTRATO=CASE WHEN COALESCE(@CONTRATOCIT,'')='' THEN  IDCONTRATO ELSE @CONTRATOCIT END
         END
               
         UPDATE CIT SET IDCONTRATO = @IDCONTRATO
         WHERE  CONSECUTIVO = @CONSECUTIVO
               
         UPDATE CNT SET VLRUTILIZADO = 0 
         WHERE  VLRUTILIZADO IS NULL
         AND    IDCONTRATO = @IDCONTRATO
         
         IF @TIPORESTA = 'F'
         BEGIN
            UPDATE CNT SET VLRUTILIZADO = VLRUTILIZADO + @VALORE
            WHERE  IDCONTRATO = @IDCONTRATO
         END
         IF @TIPORESTA = 'S'
         BEGIN
            UPDATE CNT SET VLRUTILIZADO = VLRUTILIZADO + @VALOR
            WHERE  IDCONTRATO = @IDCONTRATO
         END                
         IF EXISTS(SELECT * FROM CNTD WHERE IDCONTRATO=@IDCONTRATO)
         BEGIN
            SELECT @GRUPO=PRE.GRUPO
            FROM PRE INNER JOIN SER ON PRE.PREFIJO=SER.PREFIJO
            WHERE SER.IDSERVICIO=@IDSERVICIO

            IF @TIPORESTA = 'F'
            BEGIN
                UPDATE CNTD SET VLRUTILIZADO=COALESCE(VLRUTILIZADO,0)+@VALORE
                WHERE IDCONTRATO=@IDCONTRATO
                AND CONCEPTO=@GRUPO
                AND    FECHAINI   >= @FECHA
                AND    FECHAFIN <= @FECHA 
            END
            IF @TIPORESTA = 'S'
            BEGIN
               UPDATE CNTD SET VLRUTILIZADO=COALESCE(VLRUTILIZADO,0)+@VALORE
                WHERE IDCONTRATO=@IDCONTRATO
                AND CONCEPTO=@GRUPO
                AND    FECHAINI   >= @FECHA
                AND    FECHAFIN <= @FECHA 
            END  
         END   
         FETCH NEXT FROM CIT_CURSOR  
         INTO  @CONSECUTIVO
      END
      CLOSE CIT_CURSOR  
      DEALLOCATE CIT_CURSOR  


      -- BORRADO
      DECLARE CIT_CURSOR CURSOR FOR  
      SELECT  CONSECUTIVO FROM DELETED
      WHERE   DELETED.IDAFILIADO IS NOT NULL
      OPEN    CIT_CURSOR  
      FETCH NEXT FROM CIT_CURSOR  
      INTO  @CONSECUTIVO
      WHILE @@FETCH_STATUS = 0  
      BEGIN        
         SELECT @IDCONTRATO = DELETED.IDCONTRATO,
                @VALOR      = DELETED.VALORTOTAL,
                @VALORE     = DELETED.VALORTOTAL - DELETED.VALORCOPAGO,
                @FECHA     = DELETED.FECHA,
                @IDSERVICIO= DELETED.IDSERVICIO,
                @IDAFILIADO=DELETED.IDAFILIADO,
                @IDSEDE=DELETED.IDSEDE
         FROM   DELETED 
         WHERE  CONSECUTIVO = @CONSECUTIVO
         
         SELECT @TIPORESTA = TIPORESTA 
         FROM   CNT
         WHERE  IDCONTRATO = @IDCONTRATO
         
         IF @TIPORESTA = 'F'
         BEGIN
            UPDATE CNT SET VLRUTILIZADO = VLRUTILIZADO - @VALORE
            WHERE  IDCONTRATO = @IDCONTRATO
         END
         IF @TIPORESTA = 'S'
         BEGIN
            UPDATE CNT SET VLRUTILIZADO = VLRUTILIZADO - @VALOR
            WHERE  IDCONTRATO = @IDCONTRATO
         END      
         IF EXISTS(SELECT * FROM CNTD WHERE IDCONTRATO=@IDCONTRATO)
         BEGIN
            SELECT @GRUPO=PRE.GRUPO
            FROM PRE INNER JOIN SER ON PRE.PREFIJO=SER.PREFIJO
            WHERE SER.IDSERVICIO=@IDSERVICIO

            IF @TIPORESTA = 'F'
            BEGIN
                UPDATE CNTD SET VLRUTILIZADO=COALESCE(VLRUTILIZADO,0)-@VALORE
                WHERE IDCONTRATO=@IDCONTRATO
                AND CONCEPTO=@GRUPO
                AND    FECHAINI   >= @FECHA
                AND    FECHAFIN <= @FECHA 
            END
            IF @TIPORESTA = 'S'
            BEGIN
               UPDATE CNTD SET VLRUTILIZADO=COALESCE(VLRUTILIZADO,0)-@VALOR
                WHERE IDCONTRATO=@IDCONTRATO
                AND CONCEPTO=@GRUPO
                AND    FECHAINI   >= @FECHA
                AND    FECHAFIN <= @FECHA 
            END  
         END     
         FETCH NEXT FROM CIT_CURSOR  
         INTO  @CONSECUTIVO
      END
      CLOSE CIT_CURSOR  
      DEALLOCATE CIT_CURSOR  
   END
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
GO
